# vLLM 공식 이미지 베이스
FROM vllm/vllm-openai:latest

# 작업 디렉토리 설정
WORKDIR /app

# 시스템 패키지 업데이트 및 필수 도구 설치 (단일 레이어, 캐시 제거)
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    git \
    vim \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* \
    && rm -rf /tmp/* \
    && rm -rf /var/tmp/*

# Python 패키지 의존성 파일 복사
COPY requirements.txt /app/requirements.txt

# Gradio 및 앱 의존성 설치 (vLLM 0.11.0 호환 버전)
RUN pip install --no-cache-dir \
    gradio==4.44.0 \
    transformers>=4.55.2 \
    tokenizers>=0.21.1 \
    accelerate>=0.27.0 \
    sentencepiece \
    protobuf \
    openai>=1.3.0 \
    requests \
    python-dotenv \
    && pip install --no-cache-dir -r requirements.txt || true \
    && python3 -c "import transformers; print('✅ TRANSFORMERS_VERSION=' + transformers.__version__)" \
    && rm -rf /root/.cache/pip \
    && rm -rf /tmp/*

# 애플리케이션 코드 복사
COPY . /app

# 환경 변수 설정
ENV VLLM_API_BASE=http://127.0.0.1:8000/v1
ENV VLLM_MODEL=Qwen/Qwen2.5-Coder-7B-Instruct
ENV VLLM_MODEL_NAME=Qwen/Qwen2.5-Coder-7B-Instruct
ENV HF_HOME=/root/.cache/huggingface
ENV VLLM_SERVER_URL=http://127.0.0.1:8000/v1
ENV GRADIO_SERVER_NAME=0.0.0.0
ENV GRADIO_SERVER_PORT=7860

# 포트 노출
EXPOSE 8000 7860

# 간단하고 견고한 시작 스크립트
RUN printf '#!/bin/bash\n\
set -x\n\
echo "=== Starting vLLM + Gradio ==="\n\
echo "Time: $(date)"\n\
\n\
# 환경 변수\n\
export VLLM_MODEL="Qwen/Qwen2.5-Coder-7B-Instruct"\n\
export HF_HOME=/root/.cache/huggingface\n\
\n\
# vLLM 백그라운드 시작\n\
echo "Starting vLLM server..."\n\
python3 -m vllm.entrypoints.openai.api_server \\\n\
  --model "Qwen/Qwen2.5-Coder-7B-Instruct" \\\n\
  --host 0.0.0.0 \\\n\
  --port 8000 \\\n\
  --gpu-memory-utilization 0.90 \\\n\
  --trust-remote-code 2>&1 | tee /app/vllm.log &\n\
\n\
echo "vLLM PID: $!"\n\
\n\
# 짧은 대기\n\
echo "Waiting 15 seconds for vLLM initialization..."\n\
sleep 15\n\
\n\
# Gradio 포그라운드 시작 (exec 사용)\n\
echo "Starting Gradio UI..."\n\
cd /app\n\
exec python3 app.py --server-name 0.0.0.0 --server-port 7860\n\
' > /app/start.sh && chmod +x /app/start.sh

# ENTRYPOINT 완전히 제거
ENTRYPOINT []
CMD ["/bin/bash", "/app/start.sh"]
